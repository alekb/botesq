name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

concurrency:
  group: deploy-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: false

env:
  NODE_VERSION: '20.11.1'
  PNPM_VERSION: '9.1.0'
  # Dummy DATABASE_URL for build (Prisma client generation only, no actual connection)
  DATABASE_URL: 'postgresql://build:build@localhost:5432/build'

jobs:
  # ===========================================
  # BUILD
  # ===========================================

  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      mcp-server-artifact: ${{ steps.upload-mcp.outputs.artifact-id }}
      web-artifact: ${{ steps.upload-web.outputs.artifact-id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma client
        run: pnpm db:generate

      - name: Build all packages
        run: pnpm build

      - name: Upload MCP server build
        id: upload-mcp
        uses: actions/upload-artifact@v4
        with:
          name: mcp-server-build
          path: |
            apps/mcp-server/dist/
            apps/mcp-server/package.json
          retention-days: 1

      - name: Upload web build
        id: upload-web
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: |
            apps/web/.next/
            apps/web/public/
            apps/web/package.json
          retention-days: 1

  # ===========================================
  # DEPLOY TO STAGING
  # ===========================================

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.environment != 'production'
    environment:
      name: staging
      url: https://staging.botesq.io
    steps:
      - name: Download MCP server build
        uses: actions/download-artifact@v4
        with:
          name: mcp-server-build
          path: mcp-server/

      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: web/

      - name: Deploy to staging server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/botesq

            # Pull latest changes
            git fetch origin main
            git reset --hard origin/main

            # Install dependencies
            pnpm install --frozen-lockfile

            # Generate Prisma client
            pnpm db:generate

            # Run migrations
            pnpm db:migrate

            # Build
            pnpm build

            # Restart services
            pm2 restart botesq-mcp-server --update-env
            pm2 restart botesq-web --update-env

            # Health check
            sleep 5
            curl -f http://localhost:3000/api/health || exit 1
            curl -f http://localhost:3001/health || exit 1

      - name: Notify deployment success
        if: success()
        run: echo "✅ Staging deployment successful"

  # ===========================================
  # DEPLOY TO PRODUCTION
  # ===========================================

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://botesq.io
    steps:
      - name: Download MCP server build
        uses: actions/download-artifact@v4
        with:
          name: mcp-server-build
          path: mcp-server/

      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: web/

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_SSH_KEY }}
          script: |
            cd /opt/botesq

            # Pull latest changes
            git fetch origin main
            git reset --hard origin/main

            # Install dependencies
            pnpm install --frozen-lockfile

            # Generate Prisma client
            pnpm db:generate

            # Run migrations (with backup first)
            pg_dump $DATABASE_URL > /tmp/backup-$(date +%Y%m%d-%H%M%S).sql
            pnpm db:migrate

            # Build
            pnpm build

            # Rolling restart (zero-downtime)
            pm2 reload botesq-mcp-server --update-env
            pm2 reload botesq-web --update-env

            # Health check
            sleep 10
            curl -f https://botesq.io/api/health || exit 1
            curl -f https://api.botesq.io/health || exit 1

      - name: Notify deployment success
        if: success()
        run: echo "✅ Production deployment successful"

      - name: Notify deployment failure
        if: failure()
        run: echo "❌ Production deployment failed - manual intervention may be required"
